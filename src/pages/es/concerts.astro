---
/**
 * Concerts Page - Spanish
 * List of all concerts with filters and calendar functionality
 */
import PageLayout from '@/layouts/PageLayout.astro';
import ConcertCard from '@/components/concerts/ConcertCard.astro';
import { getContent } from '@/utils/i18n';
import concertsData from '@/data/concerts.json';

const lang = 'es';
const content = await getContent(lang, 'concerts');

// Map concerts with localized content
const concerts = concertsData.concerts.map(concert => ({
  ...concert,
  venue: concert.venue[lang],
  country: concert.country[lang],
  description: concert.description[lang],
  program: concert.program.map(piece => ({
    ...piece,
    work: piece.work[lang],
  })),
}));

// Separate upcoming and past concerts
const today = new Date().toISOString().split('T')[0];
const upcomingConcerts = concerts.filter(c => c.date >= today && c.status !== 'past');
const pastConcerts = concerts.filter(c => c.date < today || c.status === 'past');

// Sort: upcoming ascending, past descending
upcomingConcerts.sort((a, b) => a.date.localeCompare(b.date));
pastConcerts.sort((a, b) => b.date.localeCompare(a.date));
---

<PageLayout
  title={content.meta.title}
  description={content.meta.description}
  lang={lang}
  breadcrumbs={[
    { label: 'Inicio', href: '/es/' },
    { label: 'Conciertos', href: '/es/concerts' }
  ]}
  showTitle={false}
>
  <!-- Hero Section -->
  <section class="mb-16 text-center">
    <h1 class="text-4xl md:text-5xl lg:text-6xl font-serif font-bold mb-4 animate-fade-in-up">
      {content.hero.title}
    </h1>
    <p class="text-xl text-text-secondary animate-fade-in-up stagger-1">
      {content.hero.subtitle}
    </p>
  </section>

  <!-- Filters -->
  <div class="flex justify-center mb-12">
    <div class="inline-flex bg-bg-secondary rounded-lg p-1" role="tablist">
      <button
        role="tab"
        aria-selected="true"
        aria-controls="upcoming-panel"
        id="upcoming-tab"
        class="filter-button active px-6 py-3 rounded-lg font-semibold transition-all"
        data-filter="upcoming"
      >
        {content.filters.upcoming}
        {upcomingConcerts.length > 0 && (
          <span class="ml-2 px-2 py-0.5 bg-color-primary/20 text-color-primary text-xs rounded-full">
            {upcomingConcerts.length}
          </span>
        )}
      </button>
      <button
        role="tab"
        aria-selected="false"
        aria-controls="past-panel"
        id="past-tab"
        class="filter-button px-6 py-3 rounded-lg font-semibold transition-all"
        data-filter="past"
      >
        {content.filters.past}
        {pastConcerts.length > 0 && (
          <span class="ml-2 px-2 py-0.5 bg-bg-tertiary text-text-secondary text-xs rounded-full">
            {pastConcerts.length}
          </span>
        )}
      </button>
      <button
        role="tab"
        aria-selected="false"
        aria-controls="all-panel"
        id="all-tab"
        class="filter-button px-6 py-3 rounded-lg font-semibold transition-all"
        data-filter="all"
      >
        {content.filters.all}
      </button>
    </div>
  </div>

  <!-- Upcoming Concerts Panel -->
  <div
    id="upcoming-panel"
    role="tabpanel"
    aria-labelledby="upcoming-tab"
    class="filter-panel"
  >
    {upcomingConcerts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
        {upcomingConcerts.map((concert, index) => (
          <ConcertCard
            concert={concert}
            content={content}
            lang={lang}
            index={index}
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <p class="text-xl text-text-secondary mb-8">
          {content.empty.upcoming}
        </p>
      </div>
    )}
  </div>

  <!-- Past Concerts Panel -->
  <div
    id="past-panel"
    role="tabpanel"
    aria-labelledby="past-tab"
    class="filter-panel hidden"
  >
    {pastConcerts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
        {pastConcerts.map((concert, index) => (
          <ConcertCard
            concert={concert}
            content={content}
            lang={lang}
            index={index}
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <p class="text-xl text-text-secondary">
          {content.empty.past}
        </p>
      </div>
    )}
  </div>

  <!-- All Concerts Panel -->
  <div
    id="all-panel"
    role="tabpanel"
    aria-labelledby="all-tab"
    class="filter-panel hidden"
  >
    {concerts.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
        {[...upcomingConcerts, ...pastConcerts].map((concert, index) => (
          <ConcertCard
            concert={concert}
            content={content}
            lang={lang}
            index={index}
          />
        ))}
      </div>
    ) : (
      <div class="text-center py-20">
        <p class="text-xl text-text-secondary">
          {content.empty.all}
        </p>
      </div>
    )}
  </div>

  <!-- CTA Section -->
  <section class="mt-20 text-center bg-gradient-to-br from-color-primary to-color-secondary text-white -mx-4 md:-mx-8 lg:-mx-12 px-4 md:px-8 lg:px-12 py-16 rounded-lg">
    <h2 class="text-3xl md:text-4xl font-serif font-bold mb-4 animate-fade-in-up">
      {content.cta.heading}
    </h2>
    <p class="text-lg mb-8 opacity-90 max-w-2xl mx-auto animate-fade-in-up stagger-1">
      {content.cta.text}
    </p>

    <a
      href="/es/contacto"
      class="inline-block px-8 py-4 bg-white text-color-primary font-semibold rounded-lg hover:bg-opacity-90 transition-all hover:scale-105 animate-fade-in-up stagger-2"
    >
      {content.cta.button}
    </a>
  </section>
</PageLayout>

<style>
  .stagger-1 { animation-delay: 100ms; }
  .stagger-2 { animation-delay: 200ms; }

  .filter-button {
    color: var(--text-secondary);
  }

  .filter-button.active {
    background: var(--color-primary);
    color: var(--color-btn-primary-text, white);
  }

  .filter-button:hover:not(.active) {
    background: var(--bg-tertiary);
    color: var(--text-primary);
  }
</style>

<script>
  import { downloadICS, type CalendarEvent } from '@/utils/calendar';

  // Filter buttons functionality
  const filterButtons = document.querySelectorAll('.filter-button');
  const filterPanels = document.querySelectorAll('.filter-panel');

  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const filter = button.getAttribute('data-filter');

      // Update active button
      filterButtons.forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-selected', 'false');
      });
      button.classList.add('active');
      button.setAttribute('aria-selected', 'true');

      // Show corresponding panel
      filterPanels.forEach(panel => {
        panel.classList.add('hidden');
      });
      document.getElementById(`${filter}-panel`)?.classList.remove('hidden');
    });
  });

  // Add to Calendar functionality
  const calendarButtons = document.querySelectorAll('.add-to-calendar-btn');

  calendarButtons.forEach(button => {
    button.addEventListener('click', () => {
      const concertId = button.getAttribute('data-concert-id') || '';
      const title = button.getAttribute('data-concert-title') || '';
      const description = button.getAttribute('data-concert-description') || '';
      const location = button.getAttribute('data-concert-location') || '';
      const date = button.getAttribute('data-concert-date') || '';
      const time = button.getAttribute('data-concert-time') || '19:00';
      const durationStr = button.getAttribute('data-concert-duration') || '120';

      // Parse date and time
      const [hours, minutes] = time.split(':');
      const startDate = new Date(date);
      startDate.setHours(parseInt(hours), parseInt(minutes), 0);

      // Calculate end date (add duration in minutes)
      const duration = parseInt(durationStr);
      const endDate = new Date(startDate.getTime() + duration * 60000);

      const event: CalendarEvent = {
        title: `Cuarteto Metanoia - ${title}`,
        description: description,
        location: location,
        startDate: startDate,
        endDate: endDate,
      };

      downloadICS(event, `cuarteto-metanoia-${concertId}.ics`);
    });
  });
</script>
