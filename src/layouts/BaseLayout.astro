---
/**
 * BaseLayout - Main site layout
 */
import '@/styles/fonts.css'; // ✅ Importar fuentes self-hosted
import '@/styles/global.css';
import { themeInitScript } from '@/utils/theme';
import SEO from '@/components/common/SEO.astro';
import Header from '@/components/common/Header.astro';
import Footer from '@/components/common/Footer.astro';

// ✅ Importar fuentes para preload
import playfairBold from '@/assets/fonts/playfair-display-v40-latin-700.woff2';
import interRegular from '@/assets/fonts/inter-v20-latin-regular.woff2';

export interface Props {
  title: string;
  description: string;
  lang?: 'en' | 'es';
  image?: string;
  noIndex?: boolean;
  canonical?: string;
}

const {
  title,
  description,
  lang = 'en',
  image,
  noIndex = false,
  canonical,
} = Astro.props;

const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://cuartetometanoia.com';
const currentPath = Astro.url.pathname;
const canonicalURL = canonical || new URL(currentPath, siteUrl).toString();
---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- ✅ Preload con paths absolutos -->
    <link
      rel="preload"
      href="/fonts/playfair-display-v40-latin-700.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    <link
      rel="preload"
      href="/fonts/inter-v20-latin-regular.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />

    <SEO
      title={title}
      description={description}
      canonical={canonicalURL}
      image={image}
      noIndex={noIndex}
      lang={lang}
    />
    <script is:inline set:html={themeInitScript} />
  </head>
  <body>
    <!-- Skip to main content (accessibility) -->
    <a href="#main-content" class="skip-to-main">
      {lang === 'en' ? 'Skip to main content' : 'Saltar al contenido principal'}
    </a>

    <!-- Header -->
    <Header lang={lang} />

    <!-- Main Content -->
    <main id="main-content">
      <slot />
    </main>

    <!-- Footer -->
    <Footer lang={lang} />

    <!-- Intersection Observer for on-scroll animations -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const observerOptions = {
          threshold: 0.1,
          rootMargin: '0px 0px -100px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.classList.add('is-visible');
              observer.unobserve(entry.target);
            }
          });
        }, observerOptions);

        const elements = document.querySelectorAll('.animate-on-scroll');
        elements.forEach(el => {
          observer.observe(el);
        });
      });
    </script>
  </body>
</html>

<style is:global>
  /* Skip to main content link (accessibility) */
  .skip-to-main {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--color-primary);
    color: var(--color-btn-primary-text);
    padding: var(--space-2) var(--space-4);
    text-decoration: none;
    z-index: 100;
    border-radius: 0 0 var(--radius-base) 0;
  }

  .skip-to-main:focus {
    top: 0;
  }

  /* On-scroll animations */
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
  }

  .animate-on-scroll.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  /* Delay variants */
  .animate-on-scroll.delay-100 { transition-delay: 100ms; }
  .animate-on-scroll.delay-200 { transition-delay: 200ms; }
  .animate-on-scroll.delay-300 { transition-delay: 300ms; }
  .animate-on-scroll.delay-400 { transition-delay: 400ms; }
  .animate-on-scroll.delay-500 { transition-delay: 500ms; }
  .animate-on-scroll.delay-600 { transition-delay: 600ms; }

  /* Respect reduced motion preferences (accessibility) */
  @media (prefers-reduced-motion: reduce) {
    .animate-on-scroll {
      opacity: 1;
      transform: none;
      transition: none;
    }
  }
</style>
